# End-to-End Tests

This directory contains Playwright E2E tests for the Image Metadata Extractor application.

## Test Structure

- `upload.spec.ts` - File upload functionality (✅ **5/5 passing**)
- `metadata.spec.ts` - Metadata display and extraction (✅ **6/6 passing**)
- `export.spec.ts` - Export functionality (⚠️ **5/7 passing**)
- `cleaning.spec.ts` - Image cleaning functionality (⚠️ **3/7 passing**)
- `batch.spec.ts` - Batch processing (⚠️ **6/8 passing**)
- `mobile.spec.ts` - Mobile responsiveness (⚠️ **9/11 passing**)
- `helpers.ts` - Common test utilities

## Current Status

**Overall: 37/46 tests passing (80% success rate)**

### ✅ Working Features
- File upload and display
- Metadata extraction and display
- Basic export functionality (JSON, CSV, TXT)
- Batch file handling (basic)
- Mobile layout responsiveness
- Image preview and file information

### ⚠️ Known Issues

#### Download/Export Tests Failing
- **Issue**: Download events not triggering in test environment
- **Affected**: Image cleaning downloads, some export formats
- **Cause**: Browser download handling differences in headless mode
- **Solution**: Need to investigate download mocking or alternative testing approaches

#### Batch Progress Indicators
- **Issue**: Batch progress elements not always visible during fast processing
- **Affected**: Batch status display tests
- **Cause**: Processing completes too quickly for progress UI to appear
- **Solution**: Consider adding artificial delays or testing with larger files

#### Mobile Touch Gestures
- **Issue**: Touch events not supported in default browser context
- **Affected**: Mobile tap gesture tests
- **Cause**: Need to enable touch support in browser context
- **Solution**: Add `hasTouch: true` to mobile browser contexts

#### Selector Specificity
- **Issue**: Some CSS selectors too broad, matching multiple elements
- **Affected**: Various UI element selection tests
- **Solution**: Use more specific data-testid attributes

## Running Tests

```bash
# All tests
npm run test:e2e

# Specific browser
npm run test:e2e:chromium
npm run test:e2e:firefox
npm run test:e2e:webkit

# Specific test file
npx playwright test tests/e2e/upload.spec.ts

# Debug mode
npm run test:e2e:debug

# UI mode
npm run test:e2e:ui
```

## Test Data

Test fixtures are located in `fixtures/` directory:
- `simple.jpg` - Basic JPEG for upload tests
- `with-exif.jpg` - JPEG with camera metadata (generated by script)
- `with-gps.jpg` - JPEG with GPS coordinates (generated by script)
- `large-image.jpg` - Larger image for performance testing

Generate fixtures:
```bash
cd tests/e2e/fixtures
python3 generate_fixtures.py
```

## Data Test IDs Added

The following `data-testid` attributes have been added to components:

### Core UI Elements
- `app-title` - Main application title
- `upload-images-button` - Primary upload button
- `upload-archive-button` - ZIP archive upload button
- `file-input` - Hidden file input element

### Batch Processing
- `batch-progress` - Batch processing container
- `batch-status` - Progress text (e.g., "Processed 2 of 5")
- `batch-progress-bar` - Visual progress bar

### Image Cleaning
- `clean-button` - Download cleaned image button

## CI Integration

E2E tests run automatically on:
- Push to main branch
- Pull requests
- Manual workflow dispatch

See `.github/workflows/e2e.yml` for configuration.

## Troubleshooting

### Tests Timing Out
- Increase timeout values for slower operations
- Check if application is properly building and serving
- Verify test fixtures exist

### Download Tests Failing
- Downloads may behave differently in headless vs headed mode
- Consider using `--headed` flag for debugging
- Check browser download preferences

### Mobile Tests Issues
- Ensure proper viewport sizes are set
- Verify touch events are enabled for mobile contexts
- Check device emulation settings

### Selector Not Found
- Verify component has correct `data-testid` attribute
- Check if element is conditionally rendered
- Use more specific selectors

## Future Improvements

1. **Add more test fixtures** - Images with different metadata types
2. **Improve download testing** - Mock or intercept download operations
3. **Performance tests** - Measure load times and processing speed
4. **Visual regression tests** - Screenshot comparisons
5. **Accessibility tests** - Screen reader and keyboard navigation
6. **Error state testing** - Invalid files, network issues
7. **Browser compatibility** - Test across more browser versions

## Best Practices

- Use `data-testid` for reliable element selection
- Wait for specific conditions rather than fixed timeouts
- Keep tests independent and idempotent
- Use descriptive test names and comments
- Group related tests in describe blocks
- Clean up resources (contexts, pages) in mobile tests